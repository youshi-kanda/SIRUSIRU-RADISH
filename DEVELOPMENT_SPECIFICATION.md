# SIRUSIRU Radish é–‹ç™ºä»•æ§˜æ›¸

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: SIRUSIRU Radish AIãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ   
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0 (Difyéä¾å­˜ç‰ˆ)  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ2æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ2æ—¥

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#1-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [ç¾è¡ŒDifyã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œä»•æ§˜](#2-ç¾è¡Œdifyã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œä»•æ§˜)
3. [é–‹ç™ºæ–¹é‡](#3-é–‹ç™ºæ–¹é‡)
4. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#4-ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
5. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#5-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
6. [æ©Ÿèƒ½è¦ä»¶](#6-æ©Ÿèƒ½è¦ä»¶)
7. [éæ©Ÿèƒ½è¦ä»¶](#7-éæ©Ÿèƒ½è¦ä»¶)
8. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#8-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
9. [APIä»•æ§˜](#9-apiä»•æ§˜)
10. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜](#10-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜)
11. [ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥](#11-ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥)
12. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶](#12-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶)
13. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶](#13-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶)
14. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#14-ãƒ†ã‚¹ãƒˆè¨ˆç”»)
15. [é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#15-é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
16. [é‹ç”¨ãƒ»ä¿å®ˆ](#16-é‹ç”¨ä¿å®ˆ)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### 1.1 èƒŒæ™¯

ç¾åœ¨ã®SIRUSIRUã‚·ã‚¹ãƒ†ãƒ ã¯ã€Difyãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ä¾å­˜ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ï¼š

- **å›ç­”å“è³ªã®ä¸å®‰å®šæ€§**: ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’æ­£ã—ãå‚ç…§ã—ãªã„
- **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®åˆ¶é™**: Difyã®ä»•æ§˜ã«ç¸›ã‚‰ã‚Œã‚‹
- **ã‚³ã‚¹ãƒˆã®å•é¡Œ**: Difyãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ–™ãŒé«˜é¡
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…ã„

### 1.2 ç›®çš„

Difyã‚’å®Œå…¨ã«æ’é™¤ã—ã€ç‹¬è‡ªã®AIã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ï¼š

- âœ… **å›ç­”ç²¾åº¦ 95%ä»¥ä¸Š** ã‚’å®Ÿç¾
- âœ… **ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹å°‚ç”¨å›ç­”**ï¼ˆä¸€èˆ¬çŸ¥è­˜å›ç­”0%ï¼‰
- âœ… **å¿œç­”æ™‚é–“ 1ç§’ä»¥å†…**
- âœ… **é‹ç”¨ã‚³ã‚¹ãƒˆ 70%å‰Šæ¸›**
- âœ… **å®Œå…¨ãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§**

### 1.3 ã‚¹ã‚³ãƒ¼ãƒ—

#### é–‹ç™ºå¯¾è±¡
- Cloudflare Workers ã«ã‚ˆã‚‹ç‹¬è‡ªAIã‚¨ãƒ³ã‚¸ãƒ³
- D1 Database ã«ã‚ˆã‚‹å…¨æ–‡æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ 
- OpenAI API (GPT-4o-mini) çµ±åˆ
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIæ”¹ä¿®ï¼ˆDifyå‰Šé™¤ï¼‰
- ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
- CI/CDè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

#### å¯¾è±¡å¤–
- Djangoèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’ç¶™ç¶šä½¿ç”¨ï¼‰
- éŸ³å£°èªè­˜ãƒ»åˆæˆæ©Ÿèƒ½ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã‚’ç¶­æŒï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã‚’ç¶­æŒï¼‰

---

## 2. ç¾è¡ŒDifyã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œä»•æ§˜

> **é‡è¦**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€radish.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æŠ½å‡ºã—ãŸç¾åœ¨ã®Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‹•ä½œä»•æ§˜ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚æ–°ã‚·ã‚¹ãƒ†ãƒ ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼ˆå›ç­”ãƒ•ãƒ­ãƒ¼ï¼‰ã‚’ç¶­æŒ**ã—ã¤ã¤ã€**ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®å›ç­”ç²¾åº¦ã‚’å¤§å¹…ã«å‘ä¸Š**ã•ã›ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¾ã™ã€‚Difyã®å†…éƒ¨å®Ÿè£…ã‚’ãã®ã¾ã¾å†ç¾ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### 2.1 ç¾è¡Œã‚·ã‚¹ãƒ†ãƒ ã®æ¦‚è¦

#### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŸºæœ¬æƒ…å ±
- **ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰**: advanced-chatï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰
- **é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ã€ãªãªã„ã‚ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ç¤ã€åŠ å…¥ç¢ºèªAI
- **ä¸»è¦æ©Ÿèƒ½**: ä¿é™ºåŠ å…¥å¯å¦åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ 
- **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: Gemini 2.0 Flashï¼ˆè¤‡æ•°ãƒãƒ¼ãƒ‰ï¼‰
- **çŸ¥è­˜æ¤œç´¢**: Cohere rerank-english-v3.0ã§ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°

#### ä¼šè©±å¤‰æ•°ï¼ˆConversation Variablesï¼‰
ã‚·ã‚¹ãƒ†ãƒ ãŒä¿æŒã™ã‚‹15å€‹ã®çŠ¶æ…‹å¤‰æ•°ï¼š

```yaml
1. process: å‡¦ç†ãƒ•ãƒ­ãƒ¼è­˜åˆ¥å­ï¼ˆdefaultå€¤: "wiki"ï¼‰
2. wiki_count: Wikiæ¤œç´¢å›æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆdefault: 0ï¼‰
3. disease_name: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸç–¾ç—…å
4. user_input_backup: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
5. disease_code: ç–¾ç—…ã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼ˆJSONé…åˆ—ï¼‰
6. diseases_by_code: ç–¾ç—…ã‚³ãƒ¼ãƒ‰1ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
7. diseases_by_code2: ç–¾ç—…ã‚³ãƒ¼ãƒ‰2ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
8. extracted_conditions: æŠ½å‡ºã•ã‚ŒãŸçŠ¶æ…‹æƒ…å ±1
9. extracted_conditions2: æŠ½å‡ºã•ã‚ŒãŸçŠ¶æ…‹æƒ…å ±2
10. results: å¼•å—åˆ¤å®šçµæœ1
11. results2: å¼•å—åˆ¤å®šçµæœ2
12. accessible_docs: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ
13. permission_info: æ¨©é™æƒ…å ±ï¼ˆviewable, commentable, editableï¼‰
14. user_name: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
15. user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
```

### 2.2 ä¸»è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼1: ç–¾ç—…å vs ç—‡çŠ¶ã®åˆ†é¡

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒç–¾ç—…åã‹ç—‡çŠ¶ã‹ã‚’åˆ¤å®š

**ä½¿ç”¨LLMãƒãƒ¼ãƒ‰**: LLM 2ï¼ˆGemini 2.0 Flash, temperature: 0.7ï¼‰

**ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
```
# å½¹å‰²
ã‚ãªãŸã¯ã€åŒ»ç™‚åˆ†é‡ã«ç²¾é€šã—ãŸé«˜åº¦ãªåˆ†é¡ã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸæ–‡å­—åˆ—ãŒã€ã€Œç—…åã€ãªã®ã‹ã€Œç—‡çŠ¶ã€ãªã®ã‹ã‚’çš„ç¢ºã«åˆ¤å®šã—ã¾ã™ã€‚

# å³å®ˆäº‹é …
ãƒ»å¿…ãšã€ŒDISEASEã€ã¾ãŸã¯ã€ŒSYMPTOMã€ã®ã„ãšã‚Œã‹ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ãƒ»ãã‚Œä»¥å¤–ã®æ–‡å­—åˆ—ã‚„èª¬æ˜ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚

# åˆ¤å®šãƒ«ãƒ¼ãƒ«
1. å…¥åŠ›ãŒå…·ä½“çš„ãªç–¾æ‚£åã‚„è¨ºæ–­åã§ã‚ã‚‹å ´åˆ â†’ ã€ŒDISEASEã€ã‚’å‡ºåŠ›
   ä¾‹: èƒƒãŒã‚“ã€ç³–å°¿ç—…ã€é«˜è¡€åœ§ã€ã†ã¤ç—…ãªã©

2. å…¥åŠ›ãŒèº«ä½“çš„ãªä¸èª¿ã‚„è¨´ãˆã§ã‚ã‚‹å ´åˆ â†’ ã€ŒSYMPTOMã€ã‚’å‡ºåŠ›
   ä¾‹: é ­ãŒç—›ã„ã€èƒƒãŒã‚‚ãŸã‚Œã‚‹ã€æ¯è‹¦ã—ã„ãªã©

3. åˆ¤æ–­ã«è¿·ã†å ´åˆã¯ã€ã‚ˆã‚Šå¯èƒ½æ€§ã®é«˜ã„æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›
{{#sys.query#}}

# å‡ºåŠ›
```

**åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯**:
- `DISEASE` â†’ ç–¾ç—…ã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒ•ãƒ­ãƒ¼ã¸
- `SYMPTOM` â†’ ç—‡çŠ¶ã‹ã‚‰ç–¾ç—…å€™è£œæç¤ºãƒ•ãƒ­ãƒ¼ã¸
- `OTHER` â†’ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼2: ç—‡çŠ¶ã‹ã‚‰ç–¾ç—…å€™è£œã®æç¤º

**ç›®çš„**: ç—‡çŠ¶ã‹ã‚‰è€ƒãˆã‚‰ã‚Œã‚‹ç–¾ç—…ã‚’3ã¤æç¤º

**ä½¿ç”¨LLMãƒãƒ¼ãƒ‰**: LLM 3 (1)ï¼ˆGemini 2.0 Flash, temperature: 0.7ï¼‰

**ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
```
# å½¹å‰²
ã‚ãªãŸã¯ã€ç‰¹å®šã®åŒ»ç™‚ä¿é™ºã®åŠ å…¥ç¢ºèªã‚’è¡Œã†ã€é«˜åº¦ãªAIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¼ãˆã‚‰ã‚ŒãŸç—‡çŠ¶ã«å¯¾ã—ã€ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

# å³å®ˆäº‹é …
ãƒ»çµ¶å¯¾ã«æ–­å®šçš„ãªè¨ºæ–­ã‚’è¡Œã‚ãšã€ã€Œå¯èƒ½æ€§ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€ã¨ã„ã£ãŸè¡¨ç¾ã«ç•™ã‚ã¦ãã ã•ã„ã€‚
ãƒ»æç¤ºã™ã‚‹ç–¾ç—…åã®å€™è£œã¯3ã¤ã«ã—ã¦ãã ã•ã„ã€‚
ãƒ»å¿…ãšåŒ»ç™‚æ©Ÿé–¢ã®å—è¨ºã‚’å¼·ãæ¨å¥¨ã™ã‚‹æ–‡è¨€ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
ãƒ»å›ç­”ã®æœ€å¾Œã¯ã€å¿…ãšè¨ºæ–­åãŒåˆ†ã‹ã‚Šæ¬¡ç¬¬ã€å†åº¦å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«ä¿ƒã™æ–‡ç« ã§ç· ã‚ããã£ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼šè¨ºæ–­åãŒåˆ†ã‹ã‚Šã¾ã—ãŸã‚‰ã€å†åº¦ã”å…¥åŠ›ãã ã•ã„ã€‚ï¼‰

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨´ãˆã¦ã„ã‚‹ç—‡çŠ¶
{{#conversation.disease_name#}}

# å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹
ç—‡çŠ¶ã«ã¤ã„ã¦æ•™ãˆã¦ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ã€èƒƒãŒç—›ã„ã€ã¨ã„ã†ç—‡çŠ¶ã‹ã‚‰ã¯ã€ä»¥ä¸‹ã®æ§˜ãªç—…æ°—ã®å¯èƒ½æ€§ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ãƒ»èƒƒç‚
ãƒ»èƒƒæ½°ç˜
ãƒ»é€†æµæ€§é£Ÿé“ç‚
ã‚ãã¾ã§ã‚‚å¯èƒ½æ€§ã®æç¤ºã§ã‚ã‚Šã€AIã«ã‚ˆã‚‹è¨ºæ–­ã§ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚
æ€ã„å½“ãŸã‚‹è¨ºæ–­åãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€å†åº¦ã”å…¥åŠ›ãã ã•ã„ã€‚
```

**å‡ºåŠ›å½¢å¼**: ç–¾ç—…å€™è£œ3ã¤ã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§æç¤ºã—ã€å†å…¥åŠ›ã‚’ä¿ƒã™

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼3: ç–¾ç—…ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã¨è©³ç´°æŠ½å‡º

**ã‚¹ãƒ†ãƒƒãƒ—1: çŸ¥è­˜æ¤œç´¢**ï¼ˆKnowledge Retrieval 3ï¼‰
- **æ¤œç´¢å¯¾è±¡**: ç–¾ç—…åãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **æ¤œç´¢ã‚¯ã‚¨ãƒª**: `{{#conversation.disease_name#}}`
- **top_k**: 3ä»¶
- **ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°**: Cohere rerank-english-v3.0
- **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: Gemini 2.0 Flash (temperature: 0.7)

**ã‚¹ãƒ†ãƒƒãƒ—2: ç–¾ç—…ã‚³ãƒ¼ãƒ‰æŠ½å‡º**ï¼ˆLLM 11ï¼‰

**ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:
```
# å½¹å‰²
ã‚ãªãŸã¯ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿é …ç›®ã‚’æ­£ç¢ºã«æŠ½å‡ºã™ã‚‹ã€é«˜ç²¾åº¦ãªãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚
ä¸€åˆ‡ã®ä¼šè©±ã¯è¡Œã„ã¾ã›ã‚“ã€‚

# ç›®çš„
æä¾›ã•ã‚ŒãŸã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆã€‘ã®ä¸­ã‹ã‚‰ã€ã€å¯¾è±¡ã®ç—…åã€‘ã«ç´ã¥ãã€Œç–¾ç—…ã‚³ãƒ¼ãƒ‰ã€ã‚’**ã™ã¹ã¦**æŠ½å‡ºã—ã€
**JSONé…åˆ—ï¼ˆãƒªã‚¹ãƒˆï¼‰å½¢å¼ã®æ–‡å­—åˆ—**ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã™ã€‚

# å…¥åŠ›å¤‰æ•°
ãƒ»ã€å¯¾è±¡ã®ç—…åã€‘: {{#conversation.disease_name#}}
ãƒ»ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆã€‘: {{#context#}}

# å‡¦ç†æ‰‹é †ã¨å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
1. ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆã€‘ã®ä¸­ã‹ã‚‰ã€ã€Œç–¾ç—…å:ã€ãŒã€å¯¾è±¡ã®ç—…åã€‘ã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹ç®‡æ‰€ã‚’**ã™ã¹ã¦**ç‰¹å®šã—ã¾ã™ã€‚
2. ç‰¹å®šã—ãŸ**ãã‚Œãã‚Œã®ç®‡æ‰€**ã«ã¤ã„ã¦ã€ã€Œç–¾ç—…ã‚³ãƒ¼ãƒ‰:ã€ã®è¡Œã‹ã‚‰ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ï¼ˆä¾‹: U001ï¼‰ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
3. æŠ½å‡ºã—ãŸã™ã¹ã¦ã®ç–¾ç—…ã‚³ãƒ¼ãƒ‰ã‚’ã€**JSONé…åˆ—ï¼ˆãƒªã‚¹ãƒˆï¼‰å½¢å¼ã®æ–‡å­—åˆ—**ã«ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹: ["U001", "U002"]ï¼‰
4. å‡ºåŠ›ã¯ã€ä¸Šè¨˜ã®JSONé…åˆ—å½¢å¼ã®æ–‡å­—åˆ—ã®ã¿ã¨ã—ã€ãƒ©ãƒ™ãƒ«ã‚„èª¬æ˜ã€ä¸è¦ãªç©ºç™½ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚
5. è©²å½“ã™ã‚‹ç–¾ç—…ã‚³ãƒ¼ãƒ‰ãŒä¸€ã¤ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å¿…ãš `CODE_NOT_FOUND` ã¨ã„ã†æ–‡å­—åˆ—ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
```

**ã‚¹ãƒ†ãƒƒãƒ—3: Pythonã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ï¼ˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œãƒãƒ¼ãƒ‰ï¼‰

```python
import json
import re

def main(disease_code_list_json: str) -> dict:
    """
    JSONé…åˆ—å½¢å¼ã®æ–‡å­—åˆ—ã‚’è§£æã—ã€æœ€åˆã®3ã¤ã®è¦ç´ ã‚’å€‹åˆ¥ã®å¤‰æ•°ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
    å…¥åŠ›ã«MarkdownãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚ã€ãã‚Œã‚’è‡ªå‹•ã§é™¤å»ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚
    """
    
    output = {
        'desease_code1': '',
        'desease_code2': '',
        'desease_code3': ''
    }

    # [...] ã®éƒ¨åˆ†ã ã‘ã‚’æ­£è¦è¡¨ç¾ã§æ¢ã—ã¦æŠœãå‡ºã™
    match = re.search(r'\[.*\]', disease_code_list_json, re.DOTALL)
    if not match:
        return output

    cleaned_json_string = match.group(0)

    try:
        codes = json.loads(cleaned_json_string)
        
        if len(codes) > 0:
            output['desease_code1'] = codes[0]
        if len(codes) > 1:
            output['desease_code2'] = codes[1]
        if len(codes) > 2:
            output['desease_code3'] = codes[2]
        
    except (json.JSONDecodeError, TypeError):
        return output

    return output
```

**ã‚¹ãƒ†ãƒƒãƒ—4: ç–¾ç—…è©³ç´°ãƒ‡ãƒ¼ã‚¿æŠ½å‡º**ï¼ˆLLM 6, LLM 6 (1)ï¼‰

å„ç–¾ç—…ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼š

```
# å½¹å‰²
ã‚ãªãŸã¯ã€é«˜ç²¾åº¦ãªãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚ä¸€åˆ‡ã®ä¼šè©±ã¯è¡Œã„ã¾ã›ã‚“ã€‚

# ç›®çš„
ã‚ãªãŸã®ç›®çš„ã¯ã€æä¾›ã•ã‚ŒãŸ{{#context#}}ã®ä¸­ã‹ã‚‰ã€{{#1756433651120.desease_code1#}}ã«ä¸€è‡´ã™ã‚‹
ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯å…¨ä½“ã‚’è¤‡æ•°æ­£ç¢ºã«å…¨ã¦æŠ½å‡ºã™ã‚‹ã“ã¨ã§ã™ã€‚
ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯å…¨ã¦æŠ½å‡ºã—ã¦ãã ã•ã„

# å‡¦ç†æ‰‹é †ã¨å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
1. ã¾ãšã€ã€{{#1756433651120.desease_code1#}}ã€‘ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
2. æ¬¡ã«ã€ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆã€‘ã®ä¸­ã‹ã‚‰ã€ã€Œç–¾ç—…ã‚³ãƒ¼ãƒ‰:ã€ã®è¨˜è¿°ãŒã€
   ãã®æœ€åˆã®ç–¾ç—…ã‚³ãƒ¼ãƒ‰ã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹ç®‡æ‰€ã‚’ç‰¹å®šã—ã¾ã™ã€‚
3. ç‰¹å®šã—ãŸç®‡æ‰€ï¼ˆã€Œç–¾ç—…ã‚³ãƒ¼ãƒ‰:ã€ã®è¡Œï¼‰ã‹ã‚‰ã€æ¬¡ã®ã€Œ# ç–¾ç—…å:ã€ãŒå‡ºç¾ã™ã‚‹ç›´å‰ã¾ã§ã‚’ã€
   ä¸€ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦ã™ã¹ã¦æŠ½å‡ºã—ã¾ã™ã€‚
4. æŠ½å‡ºã—ãŸ**å˜ä¸€ã®ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯**ã‚’ã€ä¸€åˆ‡å¤‰æ›´ã›ãšã«ãã®ã¾ã¾å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
5. è©²å½“ã™ã‚‹ç–¾ç—…ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å¿…ãš `RECORD_NOT_FOUND` ã¨ã„ã†æ–‡å­—åˆ—ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
```

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼4: çŠ¶æ…‹æƒ…å ±ã®æŠ½å‡º

**Pythonã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ï¼ˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ 2ï¼‰:

```python
import re

def main(context_string: str) -> dict:
    """
    ã‚»ãƒŸã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ã€ŒçŠ¶æ…‹:ã€ã®ç›´å¾Œã‹ã‚‰
    æ¬¡ã®ã‚»ãƒŸã‚³ãƒ­ãƒ³ã¾ã§ã®é–“ã®æ–‡å­—åˆ—ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
    """
    
    pattern = r"çŠ¶æ…‹:\s*(.*?);"
    match = re.search(pattern, context_string)
    
    extracted_condition = ""
    
    if match:
        extracted_condition = match.group(1).strip()
    else:
        extracted_condition = "CONDITION_NOT_FOUND"

    return {
        "condition": extracted_condition
    }
```

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼5: å¼•å—åˆ¤å®šè©³ç´°ã®æŠ½å‡º

**Pythonã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ï¼ˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ 2 (2), 2 (3)ï¼‰:

```python
import re

def main(context_string: str) -> dict:
    """
    ã‚»ãƒŸã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­ã‹ã‚‰ã€ã€Œä¸»å¥‘ç´„:ã€ä»¥é™ã®
    ã™ã¹ã¦ã®æ–‡å­—åˆ—ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
    """
    
    start_keyword = "ä¸»å¥‘ç´„:"
    extracted_details = ""
    
    start_index = context_string.find(start_keyword)
    
    if start_index != -1:
        extracted_details = context_string[start_index:].strip()
    else:
        extracted_details = "DETAILS_NOT_FOUND"
        
    return {
        "underwriting_details": extracted_details
    }
```

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼6: æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã«åŸºã¥ã„ã¦ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹çµæœã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**å®Ÿè£…**: é•·å¤§ãªPythonã‚³ãƒ¼ãƒ‰ï¼ˆç´„200è¡Œï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å®Ÿæ–½

**ä¸»è¦ãƒ­ã‚¸ãƒƒã‚¯**:
1. `accessible_docs`ï¼ˆã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆï¼‰ã‚’å–å¾—
2. `permission_info`ï¼ˆviewable, commentable, editable ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã‚’è§£æ
3. çŸ¥è­˜æ¤œç´¢çµæœã‹ã‚‰å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè­˜åˆ¥å­ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒªã‚¹ãƒˆã‚’ç…§åˆ
5. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§è¿”å´

### 2.3 çŸ¥è­˜æ¤œç´¢ã®è¨­å®š

#### ä¸»è¦çŸ¥è­˜æ¤œç´¢ãƒãƒ¼ãƒ‰ï¼ˆKnowledge Retrievalï¼‰

**æ¤œç´¢è¨­å®š1**ï¼ˆç–¾ç—…åæ¤œç´¢ï¼‰:
```yaml
dataset_ids: [ANjvf6OjduHWpGasghwV6esvDFq9dIYUrs5wRxtf8nh8d6UW/4spl2hCK4g5+d/g]
retrieval_mode: multiple
top_k: 3
reranking_enable: true
reranking_model: 
  provider: langgenius/cohere/cohere
  model: rerank-english-v3.0
metadata_model_config:
  name: gemini-2.0-flash
  temperature: 0.7
```

**æ¤œç´¢è¨­å®š2**ï¼ˆç–¾ç—…ã‚³ãƒ¼ãƒ‰æ¤œç´¢ï¼‰:
```yaml
dataset_ids: [KII5ypD2FtZjtdf6LEjyICdPZX8p1BwDx+Mcg6w2zcaPlt2UTNeVg4XOX/VWKetG]
retrieval_mode: multiple
top_k: 10
reranking_enable: true
reranking_model:
  provider: langgenius/cohere/cohere
  model: rerank-english-v3.0
vector_weight: 1
keyword_weight: 0
embedding_model: text-embedding-3-large (OpenAI)
```

### 2.4 å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç—‡çŠ¶å…¥åŠ›æ™‚ã®å›ç­”ä¾‹

```
ç—‡çŠ¶ã«ã¤ã„ã¦æ•™ãˆã¦ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ã€èƒƒãŒç—›ã„ã€ã¨ã„ã†ç—‡çŠ¶ã‹ã‚‰ã¯ã€ä»¥ä¸‹ã®æ§˜ãªç—…æ°—ã®å¯èƒ½æ€§ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ãƒ»èƒƒç‚
ãƒ»èƒƒæ½°ç˜
ãƒ»é€†æµæ€§é£Ÿé“ç‚
ã‚ãã¾ã§ã‚‚å¯èƒ½æ€§ã®æç¤ºã§ã‚ã‚Šã€AIã«ã‚ˆã‚‹è¨ºæ–­ã§ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚
æ€ã„å½“ãŸã‚‹è¨ºæ–­åãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€å†åº¦ã”å…¥åŠ›ãã ã•ã„ã€‚
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç–¾ç—…åå…¥åŠ›æ™‚ã®åˆ¤å®šçµæœ

```
ãŠå•ã„åˆã‚ã›ã„ãŸã ã„ãŸå†…å®¹ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šåˆ¤å®šã•ã‚Œã¾ã—ãŸã€‚
ç—…åï¼š {{#conversation.disease_name#}}
çŠ¶æ…‹ï¼š {{#conversation.extracted_conditions#}}
éƒ¨ä½ä¸æ‹…ä¿ï¼š ãªã—
{{#conversation.results#}}
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¨ãƒ©ãƒ¼æ™‚

```
ç—…åã€ç—‡çŠ¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
```

### 2.5 ç¾è¡Œã‚·ã‚¹ãƒ†ãƒ ã®å•é¡Œç‚¹

#### ğŸ”´ é‡å¤§ãªå•é¡Œ

1. **Temperatureè¨­å®šãŒé«˜ã™ãã‚‹ï¼ˆ0.7ï¼‰**
   - å…¨LLMãƒãƒ¼ãƒ‰ã§temperature: 0.7ã‚’ä½¿ç”¨
   - ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ã§ã¯0.1ã€œ0.3ãŒé©åˆ‡
   - **å½±éŸ¿**: å‰µé€ çš„ã™ãã‚‹å›ç­”ã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ç™ºç”Ÿ

2. **è¤‡é›‘ã™ãã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**
   - 15å€‹ä»¥ä¸Šã®ãƒãƒ¼ãƒ‰ãŒé€£é–
   - ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®å¢—åŠ 

3. **æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å®Ÿè£…**
   - 200è¡Œã®Pythonã‚³ãƒ¼ãƒ‰ï¼ˆä¿å®ˆå›°é›£ï¼‰
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¸ååˆ†
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

4. **ãƒ¢ãƒ‡ãƒ«é¸æŠã®éåŠ¹ç‡æ€§**
   - Gemini 2.0 Flashä½¿ç”¨ï¼ˆã‚³ã‚¹ãƒˆé«˜ï¼‰
   - OpenAI GPT-4o-miniã®æ–¹ãŒä½ã‚³ã‚¹ãƒˆãƒ»é«˜å“è³ª

5. **ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®è¨€èªãƒŸã‚¹ãƒãƒƒãƒ**
   - Cohere rerank-english-v3.0ä½¿ç”¨
   - æ—¥æœ¬èªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¯¾ã—ã¦è‹±èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
   - **å½±éŸ¿**: æ¤œç´¢ç²¾åº¦ã®ä½ä¸‹

#### ğŸŸ¡ ä¸­ç¨‹åº¦ã®å•é¡Œ

6. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸è¦ªåˆ‡ã•**
   - ã€Œç—…åã€ç—‡çŠ¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€ã®ã¿
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä½•ãŒæ‚ªã„ã®ã‹ä¼ã‚ã‚‰ãªã„

7. **ä¼šè©±å¤‰æ•°ã®éå‰°ä½¿ç”¨**
   - 15å€‹ã®å¤‰æ•°ï¼ˆå®Ÿéš›ã«å¿…è¦ãªã®ã¯5ã€œ7å€‹ï¼‰
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¢—åŠ 

8. **æ¤œç´¢çµæœã®top_kè¨­å®šã®ä¸çµ±ä¸€**
   - ãƒãƒ¼ãƒ‰1: top_k=3
   - ãƒãƒ¼ãƒ‰2: top_k=10
   - åŸºæº–ãŒä¸æ˜ç¢º

### 2.6 æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®æ”¹å–„æ–¹é‡

> **é–‹ç™ºã®åŸºæœ¬æ–¹é‡**: Difyã®å†…éƒ¨å®Ÿè£…ï¼ˆè¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰ã¯è¸è¥²ã›ãšã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½“é¨“ã™ã‚‹å›ç­”ãƒ•ãƒ­ãƒ¼ã¯ç¶­æŒ**ã—ã¾ã™ã€‚æŠ€è¡“çš„ã«ã¯å¤§å¹…ã«ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã—ã€**ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ç²¾åº¦ã‚’æœ€å„ªå…ˆ**ã§æ”¹å–„ã—ã¾ã™ã€‚

#### ğŸ¯ ç¶­æŒã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

| é …ç›® | ç¾è¡ŒDify | æ–°ã‚·ã‚¹ãƒ†ãƒ  | å‚™è€ƒ |
|------|---------|----------|------|
| **ç—‡çŠ¶å…¥åŠ›æ™‚ã®å‹•ä½œ** | 3ã¤ã®ç–¾ç—…å€™è£œã‚’æç¤º â†’ å†å…¥åŠ›ä¿ƒã™ | âœ… **åŒã˜** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’ç¶­æŒ |
| **ç–¾ç—…åå…¥åŠ›æ™‚ã®å‹•ä½œ** | åŠ å…¥å¯å¦åˆ¤å®šçµæœã‚’è¡¨ç¤º | âœ… **åŒã˜** | å¼•å—åŸºæº–ã«åŸºã¥ãåˆ¤å®š |
| **ã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œ** | å†å…¥åŠ›ã‚’ä¿ƒã™ | âœ… **æ”¹å–„ç‰ˆ** | ã‚ˆã‚Šå…·ä½“çš„ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ |
| **å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ** | Markdownå½¢å¼ã€ç®‡æ¡æ›¸ã | âœ… **åŒã˜** | è¦‹ãŸç›®ã¯å¤‰æ›´ãªã— |

#### ğŸ”§ å¤§å¹…ã«å¤‰æ›´ã™ã‚‹å†…éƒ¨å®Ÿè£…

| å•é¡Œç‚¹ | Difyã®å®Ÿè£… | æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®å¯¾ç­– | æ”¹å–„åŠ¹æœ |
|--------|-----------|------------------|---------|
| **Temperature 0.7** | å…¨ãƒãƒ¼ãƒ‰ã§0.7 | **0.2**ï¼ˆãƒŠãƒ¬ãƒƒã‚¸å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰ | ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³95%å‰Šæ¸› |
| **è¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼** | 15ãƒãƒ¼ãƒ‰ã®é€£é– | **ã‚·ãƒ³ãƒ—ãƒ«ãª3ã‚¹ãƒ†ãƒƒãƒ—** | ãƒ‡ãƒãƒƒã‚°å®¹æ˜“ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹é«˜é€ŸåŒ– |
| **AIãƒ¢ãƒ‡ãƒ«é¸æŠ** | Gemini 2.0 Flash | **OpenAI GPT-4o-mini** | ã‚³ã‚¹ãƒˆ97%å‰Šæ¸›ã€å“è³ªå‘ä¸Š |
| **ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°** | Cohereè‹±èªãƒ¢ãƒ‡ãƒ« | **D1 FTS5æ—¥æœ¬èªå…¨æ–‡æ¤œç´¢** | æ—¥æœ¬èªç²¾åº¦30-50%å‘ä¸Š |
| **æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°** | 200è¡Œã®Pythonã‚³ãƒ¼ãƒ‰ | **Workersç’°å¢ƒå¤‰æ•°ã§ç°¡æ½”å®Ÿè£…** | ä¿å®ˆæ€§å¤§å¹…å‘ä¸Š |
| **ä¼šè©±å¤‰æ•°ç®¡ç†** | 15å€‹ã®å¤‰æ•° | **5å€‹ã«å‰Šæ¸›** | ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ– |
| **æ¤œç´¢ç²¾åº¦** | top_kä¸çµ±ä¸€ï¼ˆ3/10ï¼‰ | **çµ±ä¸€çš„ãªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°** | å›ç­”ç²¾åº¦20-30%å‘ä¸Š |

#### ğŸ“ˆ ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ç²¾åº¦ã®æ”¹å–„ç­–

**ç¾è¡ŒDifyã®å•é¡Œ**:
- Cohere rerank-english-v3.0ï¼ˆè‹±èªãƒ¢ãƒ‡ãƒ«ï¼‰ã§æ—¥æœ¬èªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°
- æ¤œç´¢çµæœã®top_kè¨­å®šãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„ï¼ˆ3ä»¶/10ä»¶ï¼‰
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ã¿ã«ä¾å­˜ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãªã—ï¼‰

**æ–°ã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„**:
1. **æ—¥æœ¬èªå¯¾å¿œå…¨æ–‡æ¤œç´¢**
   - D1ã®FTS5ï¼ˆFull-Text Searchï¼‰ã§æ—¥æœ¬èªå½¢æ…‹ç´ è§£æ
   - ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´ã‚’é«˜ã‚¹ã‚³ã‚¢åŒ–ï¼ˆ10ç‚¹ï¼‰
   - æœ¬æ–‡ä¸€è‡´ã‚’æ¨™æº–ã‚¹ã‚³ã‚¢åŒ–ï¼ˆ5ç‚¹ï¼‰

2. **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢**
   - å…¨æ–‡æ¤œç´¢ + ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
   - ç–¾ç—…ã‚³ãƒ¼ãƒ‰ã®å®Œå…¨ä¸€è‡´ã‚’æœ€å„ªå…ˆ

3. **çµ±ä¸€çš„ãªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**
   - ã™ã¹ã¦ã®æ¤œç´¢ã§top_k=10ã«çµ±ä¸€
   - ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã‚’ä»˜ä¸ï¼ˆ0.0-1.0ï¼‰
   - ã‚¹ã‚³ã‚¢0.7æœªæº€ã¯ã€Œè©²å½“ãªã—ã€æ‰±ã„

4. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–**
   - Temperature: 0.7 â†’ 0.2ï¼ˆæ±ºå®šè«–çš„ãªå›ç­”ï¼‰
   - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã€ŒãƒŠãƒ¬ãƒƒã‚¸ã®ã¿ä½¿ç”¨ã€ã‚’æ˜è¨˜
   - ä¸€èˆ¬çŸ¥è­˜ã§ã®å›ç­”ã‚’ç¦æ­¢

#### ğŸ’¡ å®Ÿè£…æ–¹é‡ã®é•ã„

| è¦³ç‚¹ | Difyã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | æ–°ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ |
|------|--------------|-------------------|
| **å“²å­¦** | ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£… |
| **è¤‡é›‘ã•** | 15ãƒãƒ¼ãƒ‰ã€200è¡ŒPython | 3ã‚¹ãƒ†ãƒƒãƒ—ã€50è¡ŒTypeScript |
| **ãƒ‡ãƒãƒƒã‚°** | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å›³ã§è¿½è·¡ | ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ã€æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ |
| **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º** | Dify UIã§è¨­å®š | ã‚³ãƒ¼ãƒ‰ã§è‡ªç”±ã«å¤‰æ›´å¯èƒ½ |
| **ä¿å®ˆæ€§** | ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ | å®Œå…¨è‡ªç¤¾ç®¡ç† |

---

## 3. é–‹ç™ºæ–¹é‡

### 3.1 åŸºæœ¬æ–¹é‡

#### å„ªå…ˆé †ä½
1. **ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ç²¾åº¦** > ã™ã¹ã¦ï¼ˆæœ€é‡è¦ï¼‰
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ç¶­æŒ** > å†…éƒ¨å®Ÿè£…ã®è¸è¥²
3. **ã‚³ã‚¹ãƒˆå‰Šæ¸›** > æ©Ÿèƒ½è¿½åŠ 
4. **ã‚·ãƒ³ãƒ—ãƒ«ã•** > è¤‡é›‘ãªæ©Ÿèƒ½
5. **ä¿å®ˆæ€§** > ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### é–‹ç™ºåŸå‰‡
- **KISSåŸå‰‡**: Keep It Simple, Stupidï¼ˆDifyã®è¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä¸è¦ï¼‰
- **YAGNIåŸå‰‡**: You Aren't Gonna Need Itï¼ˆDifyã®15ãƒãƒ¼ãƒ‰ã¯éå‰°ã€3ã‚¹ãƒ†ãƒƒãƒ—ã§ååˆ†ï¼‰
- **DRYåŸå‰‡**: Don't Repeat Yourself
- **Knowledge First**: ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®å›ç­”ç²¾åº¦ã‚’æœ€å„ªå…ˆ

### 3.2 æŠ€è¡“é¸å®šã®ç†ç”±

| æŠ€è¡“ | é¸å®šç†ç”± |
|------|---------|
| **Cloudflare Workers** | ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã€ã‚¨ãƒƒã‚¸å®Ÿè¡Œã€ç„¡é™ã‚¹ã‚±ãƒ¼ãƒ«ã€ä½ã‚³ã‚¹ãƒˆ |
| **Cloudflare D1** | SQLiteäº’æ›ã€ç„¡æ–™æ ãŒå¤§ãã„ã€Workersçµ±åˆ |
| **OpenAI GPT-4o-mini** | é«˜å“è³ªã€ä½ã‚³ã‚¹ãƒˆï¼ˆGPT-4oã®1/33ï¼‰ã€æ—¥æœ¬èªå¯¾å¿œ |
| **GitHub Actions** | ç„¡æ–™ã€è¨­å®šç°¡å˜ã€Cloudflareçµ±åˆ |
| **Vanilla JS** | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¸è¦ã€è»½é‡ã€ä¿å®ˆå®¹æ˜“ |

### 3.3 æ®µéšçš„å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### Phase 1: MVPï¼ˆæœ€å°æ©Ÿèƒ½ç‰ˆï¼‰- 2é€±é–“
- åŸºæœ¬ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
- ã‚·ãƒ³ãƒ—ãƒ«ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢
- 1ãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ

#### Phase 2: æ‹¡å¼µç‰ˆ - è¿½åŠ 2é€±é–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ
- é«˜åº¦ãªãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

---

## 4. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 4.1 å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User (Browser)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Cloudflare Pages (Frontend)                     â”‚
â”‚  - index.html, script.js, style.css                         â”‚
â”‚  - Static Hosting                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ REST API (HTTPS)
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloudflare Workers (AI Engine + API Gateway)        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Router                                              â”‚  â”‚
â”‚  â”‚  - /api/chat          â†’ Chat Handler               â”‚  â”‚
â”‚  â”‚  - /api/knowledge/*   â†’ Knowledge Manager           â”‚  â”‚
â”‚  â”‚  - /api/health        â†’ Health Check                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AI Engine Core                                      â”‚  â”‚
â”‚  â”‚  1. Knowledge Search (D1 Full-text)                 â”‚  â”‚
â”‚  â”‚  2. Answer Generation (OpenAI API)                  â”‚  â”‚
â”‚  â”‚  3. Response Validation                             â”‚  â”‚
â”‚  â”‚  4. Cache Management (KV)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â†“            â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ D1 DB   â”‚ â”‚ KV      â”‚ â”‚ R2      â”‚ â”‚ OpenAI API   â”‚
â”‚(SQLite) â”‚ â”‚(Cache)  â”‚ â”‚(Backup) â”‚ â”‚(GPT-4o-mini) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
User Query
    â”‚
    â†“
[Frontend] â†’ POST /api/chat { query, conversation_id }
    â”‚
    â†“
[Workers] 
    â”‚
    â”œâ”€â†’ [Cache Check (KV)]
    â”‚       â”‚
    â”‚       â”œâ”€â†’ Hit â†’ Return cached response
    â”‚       â”‚
    â”‚       â””â”€â†’ Miss â†“
    â”‚
    â”œâ”€â†’ [Knowledge Search (D1)]
    â”‚       â”‚
    â”‚       â””â”€â†’ SELECT * FROM knowledge WHERE ... LIKE '%query%'
    â”‚           â”‚
    â”‚           â””â”€â†’ knowledge[] (top 5 results)
    â”‚
    â”œâ”€â†’ [Answer Generation (OpenAI)]
    â”‚       â”‚
    â”‚       â””â”€â†’ POST https://api.openai.com/v1/chat/completions
    â”‚           â”‚
    â”‚           â””â”€â†’ AI Answer
    â”‚
    â”œâ”€â†’ [Response Validation]
    â”‚       â”‚
    â”‚       â”œâ”€â†’ Has sources? âœ“
    â”‚       â”œâ”€â†’ Not generic? âœ“
    â”‚       â””â”€â†’ High confidence? âœ“
    â”‚
    â”œâ”€â†’ [Save to Cache (KV)]
    â”‚
    â””â”€â†’ [Return to Frontend]
            â”‚
            â””â”€â†’ Display Answer + Sources
```

---

## 5. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 5.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

| é …ç›® | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|------|------|----------|
| **HTML** | HTML5 | - |
| **CSS** | CSS3 | - |
| **JavaScript** | Vanilla JS (ES2022) | - |
| **Markdown Parser** | marked.js | 12.0.0 |
| **Icons** | Font Awesome | 6.7.1 |
| **Hosting** | Cloudflare Pages | - |

### 5.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

| é …ç›® | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|------|------|----------|
| **Runtime** | Cloudflare Workers | - |
| **Language** | JavaScript (ES2022) | - |
| **Database** | Cloudflare D1 (SQLite) | - |
| **Cache** | Cloudflare KV | - |
| **Storage** | Cloudflare R2 | - |
| **AI Model** | OpenAI GPT-4o-mini | - |

### 4.3 é–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

| é …ç›® | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|------|------|----------|
| **Version Control** | Git + GitHub | - |
| **CI/CD** | GitHub Actions | - |
| **Package Manager** | npm | 10.x |
| **Deploy Tool** | Wrangler CLI | 3.x |
| **Testing** | Vitest | 1.x |

### 5.4 å¤–éƒ¨API

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | æ–™é‡‘ |
|---------|------|------|
| **OpenAI API** | AIå›ç­”ç”Ÿæˆ | $0.15/1M tokens (å…¥åŠ›) |
| **Django API** | èªè¨¼ãƒ»æ¨©é™ç®¡ç† | æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ  |

---

## 6. æ©Ÿèƒ½è¦ä»¶

### 6.1 ã‚³ã‚¢æ©Ÿèƒ½

#### F-001: AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ã‚­ã‚¹ãƒˆã§è³ªå•ã—ã€AIãŒå›ç­”ã™ã‚‹
- **è©³ç´°è¦ä»¶**:
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆtextareaï¼‰
  - é€ä¿¡ãƒœã‚¿ãƒ³
  - ãƒãƒ£ãƒƒãƒˆå±¥æ­´è¡¨ç¤º
  - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°éå¯¾å¿œï¼ˆblocking modeï¼‰
  - ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¯¾å¿œã®å›ç­”è¡¨ç¤º
  - å¼•ç”¨å…ƒã®æ˜ç¤º

#### F-002: ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’å…¨æ–‡æ¤œç´¢
- **è©³ç´°è¦ä»¶**:
  - SQL LIKEæ¤œç´¢
  - ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ã®ä¸¡æ–¹ã‚’æ¤œç´¢
  - ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ©Ÿèƒ½ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´=10ç‚¹ã€æœ¬æ–‡ä¸€è‡´=5ç‚¹ï¼‰
  - å„ªå…ˆåº¦ã«ã‚ˆã‚‹é‡ã¿ä»˜ã‘
  - ä¸Šä½5ä»¶ã‚’è¿”å´

#### F-003: AIå›ç­”ç”Ÿæˆ
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: OpenAI APIã§ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®å›ç­”ã‚’ç”Ÿæˆ
- **è©³ç´°è¦ä»¶**:
  - GPT-4o-miniä½¿ç”¨
  - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å³æ ¼ãªåˆ¶ç´„
  - ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®ã¿å‚ç…§
  - æœ€å¤§500ãƒˆãƒ¼ã‚¯ãƒ³
  - temperature: 0.1ï¼ˆæ­£ç¢ºæ€§é‡è¦–ï¼‰

#### F-004: å›ç­”æ¤œè¨¼
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: AIå›ç­”ã®å“è³ªã‚’è‡ªå‹•æ¤œè¨¼
- **è©³ç´°è¦ä»¶**:
  - å¼•ç”¨å…ƒã®æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
  - ä¸€èˆ¬çš„ãªãƒ•ãƒ¬ãƒ¼ã‚ºã®æ¤œå‡º
  - æœ€ä½æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆ50æ–‡å­—ä»¥ä¸Šï¼‰
  - ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—
  - ä¸åˆæ ¼ã®å ´åˆã¯æ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿”å´

#### F-005: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 
- **å„ªå…ˆåº¦**: ğŸŸ¡ æ¨å¥¨
- **èª¬æ˜**: åŒã˜è³ªå•ã®é‡è¤‡å‡¦ç†ã‚’é˜²ã
- **è©³ç´°è¦ä»¶**:
  - KV Storageã«ä¿å­˜
  - ã‚¯ã‚¨ãƒªã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‚­ãƒ¼ã«
  - 24æ™‚é–“ã®æœ‰åŠ¹æœŸé™
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã¯OpenAIå‘¼ã³å‡ºã—ãªã—

#### F-006: ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: ãƒŠãƒ¬ãƒƒã‚¸ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- **è©³ç´°è¦ä»¶**:
  - ç®¡ç†ç”»é¢ï¼ˆknowledge-manager.htmlï¼‰
  - ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ–°è¦è¿½åŠ 
  - ä¸€è¦§è¡¨ç¤º
  - ã‚«ãƒ†ã‚´ãƒªåˆ†é¡
  - å„ªå…ˆåº¦è¨­å®šï¼ˆ1-5ï¼‰
  - ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½

#### F-007: ä¼šè©±å±¥æ­´
- **å„ªå…ˆåº¦**: ğŸŸ¢ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- **èª¬æ˜**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ä¼šè©±å±¥æ­´ä¿å­˜
- **è©³ç´°è¦ä»¶**:
  - D1ã«ä¿å­˜
  - conversation_id ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  - éå»ã®ä¼šè©±ã‚’å†é–‹å¯èƒ½
  - ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ä¸€è¦§è¡¨ç¤º

#### F-008: èªè¨¼é€£æº
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: æ—¢å­˜Djangoã‚·ã‚¹ãƒ†ãƒ ã¨é€£æº
- **è©³ç´°è¦ä»¶**:
  - JWTèªè¨¼
  - ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
  - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

### 5.2 UIæ©Ÿèƒ½

#### F-101: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: ãƒ¢ãƒã‚¤ãƒ«ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ
- **è©³ç´°è¦ä»¶**:
  - ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ: 768px (mobile), 1024px (tablet)
  - ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  - ã‚¿ãƒƒãƒæ“ä½œå¯¾å¿œ

#### F-102: ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: æ—¢å­˜ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã‚’ç¶­æŒ
- **è©³ç´°è¦ä»¶**:
  - èƒŒæ™¯è‰²: #121212
  - ãƒ†ã‚­ã‚¹ãƒˆè‰²: #FFFFFF
  - ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼: #CB6847

#### F-103: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
- **å„ªå…ˆåº¦**: ğŸ”´ å¿…é ˆ
- **èª¬æ˜**: AIå‡¦ç†ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **è©³ç´°è¦ä»¶**:
  - ã‚¹ãƒ”ãƒŠãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
  - ã€Œå›ç­”ã‚’ç”Ÿæˆä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç„¡åŠ¹åŒ–

---

## 7. éæ©Ÿèƒ½è¦ä»¶

### 7.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | æ¸¬å®šæ–¹æ³• |
|------|--------|---------|
| **å¿œç­”æ™‚é–“** | < 1ç§’ | Chrome DevTools Network |
| **åˆå›è¡¨ç¤º** | < 2ç§’ | Lighthouse |
| **Workerså®Ÿè¡Œæ™‚é–“** | < 500ms | Cloudflare Analytics |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡** | > 30% | KV Analytics |

### 7.2 å¯ç”¨æ€§

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| **ç¨¼åƒç‡** | 99.9% |
| **ã‚¨ãƒ©ãƒ¼ç‡** | < 0.1% |
| **å¾©æ—§æ™‚é–“** | < 5åˆ† |

### 6.3 æ‹¡å¼µæ€§

| é …ç›® | è¦ä»¶ |
|------|------|
| **åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°** | 100äºº |
| **1æ—¥ã‚ãŸã‚Šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ** | 10,000å› |
| **ãƒŠãƒ¬ãƒƒã‚¸ä»¶æ•°** | 1,000ä»¶ |
| **ãƒ†ãƒŠãƒ³ãƒˆæ•°** | 10ç¤¾ |

### 6.4 ä¿å®ˆæ€§

| é …ç›® | è¦ä»¶ |
|------|------|
| **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸** | > 70% |
| **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ** | ã™ã¹ã¦ã®é–¢æ•°ã«JSDoc |
| **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°** | ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ² |

---

## 8. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 8.1 D1 Database ã‚¹ã‚­ãƒ¼ãƒ

#### knowledge ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE knowledge (
  -- ä¸»ã‚­ãƒ¼
  id TEXT PRIMARY KEY,
  
  -- ãƒŠãƒ¬ãƒƒã‚¸æƒ…å ±
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT NOT NULL,
  priority INTEGER DEFAULT 3 CHECK(priority BETWEEN 1 AND 5),
  
  -- ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±
  tenant_domain TEXT NOT NULL,
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  source_file TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by TEXT,
  
  -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨
  search_text TEXT GENERATED ALWAYS AS (title || ' ' || content) VIRTUAL
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_tenant_category ON knowledge(tenant_domain, category);
CREATE INDEX idx_priority ON knowledge(priority);
CREATE INDEX idx_search ON knowledge(tenant_domain, title, content);
```

#### conversations ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```sql
CREATE TABLE conversations (
  id TEXT PRIMARY KEY,
  user_email TEXT NOT NULL,
  title TEXT,
  tenant_domain TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_conversations ON conversations(user_email, tenant_domain);
```

#### messages ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  conversation_id TEXT NOT NULL,
  role TEXT NOT NULL CHECK(role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  sources TEXT, -- JSON array
  confidence REAL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);

CREATE INDEX idx_conversation_messages ON messages(conversation_id, created_at);
```

### 8.2 KV Storage æ§‹é€ 

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
```
answer:{hash_of_query}

Value:
{
  "answer": "...",
  "sources": [...],
  "confidence": 0.89,
  "timestamp": 1730534400000
}

TTL: 86400 (24æ™‚é–“)
```

### 8.3 R2 Storage æ§‹é€ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```
knowledge/
  â”œâ”€â”€ {tenant_domain}/
  â”‚   â”œâ”€â”€ {knowledge_id}.json
  â”‚   â””â”€â”€ backups/
  â”‚       â””â”€â”€ {date}.json
```

---

## 9. APIä»•æ§˜

### 8.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èª¬æ˜ | èªè¨¼ |
|---------|------|------|------|
| POST | `/api/chat` | ãƒãƒ£ãƒƒãƒˆé€ä¿¡ | å¿…é ˆ |
| GET | `/api/knowledge/list` | ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ | å¿…é ˆ |
| POST | `/api/knowledge/upload` | ãƒŠãƒ¬ãƒƒã‚¸è¿½åŠ  | å¿…é ˆ |
| PUT | `/api/knowledge/{id}` | ãƒŠãƒ¬ãƒƒã‚¸æ›´æ–° | å¿…é ˆ |
| DELETE | `/api/knowledge/{id}` | ãƒŠãƒ¬ãƒƒã‚¸å‰Šé™¤ | å¿…é ˆ |
| GET | `/api/health` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ | ä¸è¦ |

### 8.2 è©³ç´°ä»•æ§˜

#### POST /api/chat

**Request**
```json
{
  "query": "æ–°å•†å“ã®ä¿é™ºæ–™ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ",
  "conversation_id": "conv_123456789" // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
}
```

**Response (æˆåŠŸ)**
```json
{
  "answer": "æ–°å•†å“ã€Œå®‰å¿ƒãƒ—ãƒ©ãƒ³2024ã€ã®ä¿é™ºæ–™ã¯...",
  "sources": [
    {
      "title": "æ–°å•†å“ï¼šå®‰å¿ƒãƒ—ãƒ©ãƒ³2024",
      "category": "å•†å“æƒ…å ±",
      "relevance": 0.89
    }
  ],
  "confidence": 0.89,
  "conversation_id": "conv_123456789",
  "timestamp": "2025-11-02T10:30:00Z"
}
```

**Response (ã‚¨ãƒ©ãƒ¼)**
```json
{
  "error": "No knowledge found",
  "message": "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ãã®æƒ…å ±ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
  "timestamp": "2025-11-02T10:30:00Z"
}
```

#### POST /api/knowledge/upload

**Request**
```json
{
  "title": "æ–°å•†å“ï¼šå®‰å¿ƒãƒ—ãƒ©ãƒ³2024",
  "content": "æ–°å•†å“ã€Œå®‰å¿ƒãƒ—ãƒ©ãƒ³2024ã€ã®ä¿é™ºæ–™ã¯...",
  "category": "å•†å“æƒ…å ±",
  "priority": 1
}
```

**Response**
```json
{
  "success": true,
  "id": "kb_987654321",
  "message": "ãƒŠãƒ¬ãƒƒã‚¸ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸ"
}
```

### 8.3 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

| ã‚³ãƒ¼ãƒ‰ | æ„å‘³ | å¯¾å‡¦ |
|-------|------|------|
| 400 | Bad Request | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’ç¢ºèª |
| 401 | Unauthorized | ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ |
| 404 | Not Found | ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„ |
| 429 | Too Many Requests | ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é |
| 500 | Internal Server Error | ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ |
| 503 | Service Unavailable | OpenAI APIéè² è· |

---

## 10. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä»•æ§˜

### 9.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
frontend/
â”œâ”€â”€ index.html              # ãƒ¡ã‚¤ãƒ³ç”»é¢
â”œâ”€â”€ style.css               # ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ
â”œâ”€â”€ script.js               # ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ config.js               # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ knowledge-manager.html  # ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ç”»é¢
â””â”€â”€ assets/
    â”œâ”€â”€ logo.png
    â””â”€â”€ favicon.ico
```

### 9.2 ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### ãƒãƒ£ãƒƒãƒˆç”»é¢ (index.html)

```html
<div class="chat-container">
  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="chat-messages" class="chat-messages"></div>
  
  <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
  <div class="chat-input">
    <textarea id="user-input" placeholder="è³ªå•ã‚’å…¥åŠ›..."></textarea>
    <button id="send-button">é€ä¿¡</button>
  </div>
</div>
```

#### ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ç”»é¢ (knowledge-manager.html)

```html
<div class="knowledge-manager">
  <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form id="upload-form">
    <input type="text" id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
    <select id="category">
      <option value="å•†å“æƒ…å ±">å•†å“æƒ…å ±</option>
      <option value="æ‰‹ç¶šã">æ‰‹ç¶šã</option>
      <option value="FAQ">FAQ</option>
    </select>
    <select id="priority">
      <option value="1">å„ªå…ˆåº¦1 (æœ€å„ªå…ˆ)</option>
      <option value="2">å„ªå…ˆåº¦2</option>
      <option value="3">å„ªå…ˆåº¦3</option>
    </select>
    <textarea id="content" placeholder="å†…å®¹"></textarea>
    <button type="submit">ç™»éŒ²</button>
  </form>
  
  <!-- ãƒŠãƒ¬ãƒƒã‚¸ä¸€è¦§ -->
  <table id="knowledge-table">
    <thead>
      <tr>
        <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th>ã‚«ãƒ†ã‚´ãƒª</th>
        <th>å„ªå…ˆåº¦</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
```

### 9.3 JavaScriptä¸»è¦é–¢æ•°

```javascript
// script.js

// ãƒãƒ£ãƒƒãƒˆé€ä¿¡
async function sendMessage(query) {
  const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getToken()}`
    },
    body: JSON.stringify({ query })
  });
  
  const data = await response.json();
  displayMessage(data);
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function displayMessage(data) {
  const messageEl = document.createElement('div');
  messageEl.className = 'message assistant';
  messageEl.innerHTML = marked.parse(data.answer);
  
  // å¼•ç”¨å…ƒè¡¨ç¤º
  if (data.sources && data.sources.length > 0) {
    const sourcesEl = document.createElement('div');
    sourcesEl.className = 'sources';
    sourcesEl.innerHTML = 'ğŸ“š å‚ç…§å…ƒ: ' + 
      data.sources.map(s => s.title).join(', ');
    messageEl.appendChild(sourcesEl);
  }
  
  document.getElementById('chat-messages').appendChild(messageEl);
}
```

---

## 11. ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### 10.1 ç’°å¢ƒæ§‹æˆ

| ç’°å¢ƒ | URL | ãƒ–ãƒ©ãƒ³ãƒ | ç”¨é€” |
|------|-----|---------|------|
| **æœ¬ç•ª** | `https://chat.radish-call.com` | `main` | å®Ÿé‹ç”¨ |
| **é–‹ç™º** | `https://chat-dev.radish-call.com` | `develop` | ãƒ†ã‚¹ãƒˆ |
| **ãƒ­ãƒ¼ã‚«ãƒ«** | `http://localhost:8787` | - | é–‹ç™º |

### 10.2 GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### Pages ãƒ‡ãƒ—ãƒ­ã‚¤ (.github/workflows/deploy-pages.yml)

```yaml
name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "project_name=sirusiru-radish" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "project_name=sirusiru-radish-dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ steps.env.outputs.project_name }}
          directory: frontend
```

#### Workers ãƒ‡ãƒ—ãƒ­ã‚¤ (.github/workflows/deploy-workers.yml)

```yaml
name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main, develop]
    paths:
      - 'workers/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Dependencies
        run: |
          cd workers
          npm ci
      
      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: workers
          environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
```

### 10.3 Wranglerè¨­å®š

```toml
# workers/wrangler.toml

name = "sirusiru-radish-ai"
main = "ai-engine.js"
compatibility_date = "2024-11-01"

# æœ¬ç•ªç’°å¢ƒ
[env.production]
name = "sirusiru-radish-ai"
route = { pattern = "chat.radish-call.com/*", zone_name = "radish-call.com" }
vars = { ENVIRONMENT = "production", TENANT_DOMAIN = "radish-call.com" }

# é–‹ç™ºç’°å¢ƒ
[env.development]
name = "sirusiru-radish-ai-dev"
route = { pattern = "chat-dev.radish-call.com/*", zone_name = "radish-call.com" }
vars = { ENVIRONMENT = "development", TENANT_DOMAIN = "radish-call.com" }

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "sirusiru-knowledge"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# KV Namespace
[[kv_namespaces]]
binding = "KV"
id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# R2 Bucket (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
[[r2_buckets]]
binding = "R2"
bucket_name = "sirusiru-knowledge-backup"

# Environment Secrets (GitHub Secretsã‹ã‚‰è‡ªå‹•æ³¨å…¥)
# OPENAI_API_KEY
# DJANGO_API_BASE
```

---

## 12. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

### 12.1 èªè¨¼ãƒ»èªå¯

#### JWTèªè¨¼
```javascript
// Workerså´ã§æ¤œè¨¼
async function verifyToken(request, env) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return { valid: false, error: 'No token provided' };
  }
  
  const token = authHeader.substring(7);
  
  // Django APIã§æ¤œè¨¼
  const response = await fetch(`${env.DJANGO_API_BASE}/api/token/verify/`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token })
  });
  
  return response.ok ? { valid: true } : { valid: false, error: 'Invalid token' };
}
```

### 12.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·

| é …ç›® | å¯¾ç­– |
|------|------|
| **API Key** | GitHub Secrets + Cloudflareç’°å¢ƒå¤‰æ•° |
| **é€šä¿¡** | HTTPSå¼·åˆ¶ï¼ˆCloudflareè‡ªå‹•SSLï¼‰ |
| **CORS** | è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **XSSå¯¾ç­–** | DOMPurifyä½¿ç”¨ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ï¼‰ |
| **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³** | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° |

### 11.3 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```javascript
// Workerså´ã§å®Ÿè£…
const rateLimiter = {
  limit: 100, // 100å›/åˆ†
  window: 60000, // 1åˆ†
  
  async check(ip, env) {
    const key = `ratelimit:${ip}`;
    const count = await env.KV.get(key);
    
    if (count && parseInt(count) >= this.limit) {
      return false; // ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
    }
    
    await env.KV.put(key, (parseInt(count) || 0) + 1, {
      expirationTtl: this.window / 1000
    });
    
    return true;
  }
};
```

---

## 13. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

### 12.1 æœ€é©åŒ–æˆ¦ç•¥

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```javascript
// 3å±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥
// 1. KV Storage (24æ™‚é–“)
// 2. Cloudflare Cache API (1æ™‚é–“)
// 3. ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (5åˆ†)

async function getCachedResponse(query, env) {
  const cacheKey = `answer:${hashQuery(query)}`;
  
  // KVç¢ºèª
  const cached = await env.KV.get(cacheKey, 'json');
  if (cached && !isExpired(cached.timestamp)) {
    console.log('âœ… Cache hit (KV)');
    return cached;
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ â†’ AIç”Ÿæˆ
  const answer = await generateAnswer(query, env);
  
  // KVä¿å­˜
  await env.KV.put(cacheKey, JSON.stringify({
    ...answer,
    timestamp: Date.now()
  }), {
    expirationTtl: 86400 // 24æ™‚é–“
  });
  
  return answer;
}
```

#### SQLæœ€é©åŒ–
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨
CREATE INDEX idx_search ON knowledge(tenant_domain, title, content);

-- EXPLAIN ã§ç¢ºèª
EXPLAIN QUERY PLAN
SELECT * FROM knowledge
WHERE tenant_domain = 'radish-call.com'
  AND (title LIKE '%ä¿é™ºæ–™%' OR content LIKE '%ä¿é™ºæ–™%')
ORDER BY priority ASC
LIMIT 5;
```

### 12.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™ | æ¸¬å®š |
|------|------|------|
| **Workerså®Ÿè¡Œæ™‚é–“** | < 500ms | Cloudflare Analytics |
| **D1ã‚¯ã‚¨ãƒªæ™‚é–“** | < 50ms | D1 Analytics |
| **OpenAI API** | < 800ms | ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚° |
| **åˆè¨ˆå¿œç­”æ™‚é–“** | < 1ç§’ | End-to-endæ¸¬å®š |

---

## 14. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 13.1 ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«

#### å˜ä½“ãƒ†ã‚¹ãƒˆ (Unit Test)
```javascript
// workers/tests/knowledge-search.test.js
import { describe, it, expect } from 'vitest';
import { searchKnowledge } from '../knowledge-search.js';

describe('Knowledge Search', () => {
  it('should return top 5 results', async () => {
    const results = await searchKnowledge('ä¿é™ºæ–™', mockEnv);
    expect(results).toHaveLength(5);
  });
  
  it('should prioritize by priority', async () => {
    const results = await searchKnowledge('ä¿é™ºæ–™', mockEnv);
    expect(results[0].priority).toBeLessThanOrEqual(results[1].priority);
  });
});
```

#### çµ±åˆãƒ†ã‚¹ãƒˆ (Integration Test)
```javascript
// workers/tests/api.test.js
describe('POST /api/chat', () => {
  it('should return answer with sources', async () => {
    const response = await fetch('http://localhost:8787/api/chat', {
      method: 'POST',
      body: JSON.stringify({ query: 'ä¿é™ºæ–™ã¯ã„ãã‚‰?' })
    });
    
    const data = await response.json();
    expect(data.answer).toBeDefined();
    expect(data.sources).toBeInstanceOf(Array);
  });
});
```

### 13.2 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ•ã‚¡ã‚¤ãƒ« | ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ |
|---------|--------------|
| `ai-engine.js` | 80% |
| `knowledge-search.js` | 90% |
| `openai-client.js` | 70% |
| å…¨ä½“å¹³å‡ | 75% |

### 13.3 æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

#### ã‚·ãƒŠãƒªã‚ª1: åŸºæœ¬ãƒãƒ£ãƒƒãƒˆ
1. ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã
2. ã€Œæ–°å•†å“ã®ä¿é™ºæ–™ã¯ã„ãã‚‰?ã€ã¨å…¥åŠ›
3. é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
4. 1ç§’ä»¥å†…ã«å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã‚‹
5. å¼•ç”¨å…ƒãŒè¡¨ç¤ºã•ã‚Œã‚‹

#### ã‚·ãƒŠãƒªã‚ª2: ãƒŠãƒ¬ãƒƒã‚¸ç™»éŒ²
1. ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ç”»é¢ã‚’é–‹ã
2. ã‚¿ã‚¤ãƒˆãƒ«ãƒ»å†…å®¹ã‚’å…¥åŠ›
3. ã‚«ãƒ†ã‚´ãƒªãƒ»å„ªå…ˆåº¦ã‚’é¸æŠ
4. ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
5. ã€Œç™»éŒ²å®Œäº†ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
6. ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹

#### ã‚·ãƒŠãƒªã‚ª3: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
1. ãƒŠãƒ¬ãƒƒã‚¸ã«ãªã„è³ªå•ã‚’ã™ã‚‹
2. ã€Œæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
3. OpenAI APIã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

---

## 15. é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### 14.1 Phase 1: MVPï¼ˆ2é€±é–“ï¼‰

#### Week 1

| æ—¥ | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | çŠ¶æ…‹ |
|----|--------|------|------|
| Day 1 | ç’°å¢ƒæ§‹ç¯‰ï¼ˆCloudflare, GitHubï¼‰ | Dev | - |
| Day 2 | D1ã‚¹ã‚­ãƒ¼ãƒä½œæˆ + ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ | Dev | - |
| Day 3 | WorkersåŸºæœ¬å®Ÿè£…ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰ | Dev | - |
| Day 4 | ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢å®Ÿè£… | Dev | - |
| Day 5 | OpenAIçµ±åˆå®Ÿè£… | Dev | - |

#### Week 2

| æ—¥ | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | çŠ¶æ…‹ |
|----|--------|------|------|
| Day 6 | å›ç­”æ¤œè¨¼ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£… | Dev | - |
| Day 7 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ”¹ä¿®ï¼ˆDifyå‰Šé™¤ï¼‰ | Dev | - |
| Day 8 | ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ç”»é¢å®Ÿè£… | Dev | - |
| Day 9 | CI/CDæ§‹ç¯‰ | Dev | - |
| Day 10 | çµ±åˆãƒ†ã‚¹ãƒˆ | Dev | - |
| Day 11 | ãƒã‚°ä¿®æ­£ | Dev | - |
| Day 12 | æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ | Dev | - |
| Day 13 | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ | Dev | - |

### 14.2 Phase 2: æ‹¡å¼µç‰ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€2é€±é–“ï¼‰

| Week | ã‚¿ã‚¹ã‚¯ |
|------|--------|
| Week 3 | ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œã€ä¼šè©±å±¥æ­´æ©Ÿèƒ½ |
| Week 4 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€ç›£è¦–æ©Ÿèƒ½ |

---

## 16. é‹ç”¨ãƒ»ä¿å®ˆ

### 16.1 ç›£è¦–é …ç›®

| é …ç›® | ãƒ„ãƒ¼ãƒ« | é–¾å€¤ | ã‚¢ãƒ©ãƒ¼ãƒˆ |
|------|--------|------|---------|
| **ã‚¨ãƒ©ãƒ¼ç‡** | Cloudflare Analytics | > 1% | Slacké€šçŸ¥ |
| **å¿œç­”æ™‚é–“** | Cloudflare Analytics | > 2ç§’ | Emailé€šçŸ¥ |
| **KVãƒ’ãƒƒãƒˆç‡** | KV Analytics | < 20% | é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ |
| **OpenAI APIè²»ç”¨** | OpenAI Dashboard | > Â¥20,000/æœˆ | Emailé€šçŸ¥ |

### 16.2 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

#### D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
```bash
# æ¯æ—¥è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆGitHub Actionsï¼‰
wrangler d1 export sirusiru-knowledge --output=backup/$(date +%Y%m%d).sql

# R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
wrangler r2 object put sirusiru-knowledge-backup/$(date +%Y%m%d).sql --file=backup/$(date +%Y%m%d).sql
```

#### ãƒŠãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿
- æ¯æ—¥R2ã«JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- 7æ—¥é–“ä¿æŒ
- æœˆæ¬¡ã§å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜

### 15.3 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### OpenAI API ã‚¨ãƒ©ãƒ¼
```
ã‚¨ãƒ©ãƒ¼: 503 Service Unavailable

åŸå› : OpenAI APIéè² è·
å¯¾å‡¦:
1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã‚’ä¸Šã’ã‚‹
2. ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’å®Ÿè£…
3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

#### D1ã‚¯ã‚¨ãƒªé…å»¶
```
ã‚¨ãƒ©ãƒ¼: ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ > 200ms

åŸå› : ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªä½¿ç”¨
å¯¾å‡¦:
1. EXPLAIN ã§å®Ÿè¡Œè¨ˆç”»ç¢ºèª
2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
3. ã‚¯ã‚¨ãƒªæœ€é©åŒ–
```

### 15.4 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å†…å®¹ |
|------------|------|
| **README.md** | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã€ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ |
| **DEPLOYMENT.md** | ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é † |
| **KNOWLEDGE_MANAGEMENT.md** | ãƒŠãƒ¬ãƒƒã‚¸è¿½åŠ ãƒ»ç®¡ç†æ–¹æ³• |
| **API_REFERENCE.md** | APIè©³ç´°ä»•æ§˜ |
| **TROUBLESHOOTING.md** | ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³• |
| **MAINTENANCE.md** | å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ‰‹é † |

---

## ä»˜éŒ²

### A. ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|------|------|
| **Workers** | Cloudflare Workersï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹å®Ÿè¡Œç’°å¢ƒï¼‰ |
| **D1** | Cloudflare D1 Databaseï¼ˆSQLiteäº’æ›ï¼‰ |
| **KV** | Key-Value Storageï¼ˆCloudflare KVï¼‰ |
| **R2** | Object Storageï¼ˆCloudflare R2ï¼‰ |
| **RAG** | Retrieval-Augmented Generationï¼ˆæ¤œç´¢æ‹¡å¼µç”Ÿæˆï¼‰ |
| **MVP** | Minimum Viable Productï¼ˆæœ€å°æ©Ÿèƒ½è£½å“ï¼‰ |

### B. å‚è€ƒãƒªãƒ³ã‚¯

- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare D1 Docs](https://developers.cloudflare.com/d1/)
- [OpenAI API Reference](https://platform.openai.com/docs/api-reference)
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/)

### C. å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | æ‹…å½“ |
|------|-----------|---------|------|
| 2025-11-02 | 1.0 | åˆç‰ˆä½œæˆ | - |

---

**æ‰¿èªæ¬„**

| å½¹å‰² | æ°å | ç½²å | æ—¥ä»˜ |
|------|------|------|------|
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | | | |
| æŠ€è¡“è²¬ä»»è€… | | | |
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ‰¿èª | | | |

---

**æœ¬ä»•æ§˜æ›¸ã¯é–‹ç™ºé–‹å§‹å‰ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ‰¿èªã‚’å¾—ã¦ãã ã•ã„**
